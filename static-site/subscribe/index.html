<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Support a Scout | Camp Card — Scouting America</title>
  <meta name="description" content="A Scout invited you to buy a Camp Card for just $10. Unlock exclusive local discounts while directly funding a Scout's camp experience.">
  <link rel="canonical" href="https://www.campcardapp.org/subscribe/">
  <meta name="robots" content="index,follow">

  <meta property="og:type" content="website">
  <meta property="og:title" content="Support a Scout | Camp Card — Scouting America">
  <meta property="og:description" content="A Scout invited you to buy a Camp Card for just $10. Unlock exclusive local discounts while directly funding a Scout's camp experience.">
  <meta property="og:url" content="https://www.campcardapp.org/subscribe/">

  <meta name="theme-color" content="#001a3a">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">

  <style>
    .checkout-layout {
      display: grid;
      grid-template-columns: 1fr 1.2fr;
      gap: 32px;
      align-items: start;
      padding: 40px 0 60px;
    }

    .order-summary {
      border: 1px solid rgba(0,0,0,0.14);
      border-radius: 18px;
      padding: 24px;
      background: #fff;
      position: sticky;
      top: 100px;
    }

    .order-summary h2 {
      margin: 0 0 16px;
      font-size: 22px;
      letter-spacing: -0.01em;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }

    .order-item:last-of-type { border-bottom: none; }

    .order-item-name { font-weight: 700; font-size: 18px; }
    .order-item-desc { color: var(--color-muted); font-size: 14px; margin-top: 2px; }
    .order-item-price { font-weight: 800; font-size: 22px; color: var(--color-navy-2); }

    .order-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 14px;
      margin-top: 6px;
      border-top: 2px solid var(--color-navy-2);
    }

    .order-total-label { font-weight: 800; font-size: 18px; }
    .order-total-price { font-weight: 800; font-size: 26px; color: var(--color-red); }

    .order-trust {
      margin-top: 18px;
      padding: 14px;
      background: rgba(0,166,81,0.06);
      border: 1px solid rgba(0,166,81,0.18);
      border-radius: 12px;
      font-size: 14px;
      color: #1a5c32;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .order-trust svg {
      width: 20px; height: 20px; flex-shrink: 0;
      stroke: #1a5c32; fill: none; stroke-width: 2; margin-top: 1px;
    }

    .payment-panel { min-height: 480px; }
    .payment-panel h2 { margin: 0 0 8px; font-size: 22px; }
    .payment-panel > p { margin: 0 0 20px; color: var(--color-muted); font-size: 15px; }

    /* Scout referral banner */
    .scout-referral-banner {
      background: linear-gradient(135deg, rgba(0,166,81,0.08) 0%, rgba(13,44,94,0.06) 100%);
      border: 1px solid rgba(0,166,81,0.22);
      border-radius: 14px;
      padding: 16px 18px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .scout-referral-banner svg {
      width: 28px; height: 28px; stroke: #1a5c32; fill: none; stroke-width: 2; flex-shrink: 0;
    }
    .scout-referral-banner .banner-text {
      font-size: 15px; color: #1a5c32; line-height: 1.4;
    }
    .scout-referral-banner .banner-text strong {
      font-weight: 800;
    }

    .scout-discount-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(208,0,42,0.08);
      color: var(--color-red);
      font-weight: 700;
      font-size: 14px;
      padding: 6px 14px;
      border-radius: 999px;
      margin-bottom: 18px;
    }

    /* Form fields */
    .form-group { margin-bottom: 16px; }
    .form-group label {
      display: block; font-weight: 700; margin-bottom: 6px; font-size: 15px;
    }
    .form-group input {
      width: 100%; padding: 12px 14px;
      border: 1px solid rgba(0,0,0,0.18); border-radius: 12px;
      font: inherit; font-size: 16px; background: #fff;
    }
    .form-group input:focus {
      outline: none; border-color: var(--color-navy-2);
      box-shadow: 0 0 0 3px rgba(13,44,94,0.12);
    }
    .form-group input.field-error { border-color: var(--color-red); }
    .form-group .hint { color: var(--color-muted); font-size: 13px; margin-top: 6px; }
    .form-group .field-error-msg { color: var(--color-red); font-size: 13px; margin-top: 4px; display: none; }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    /* Card visual */
    .card-section-label {
      font-weight: 800; font-size: 14px; text-transform: uppercase;
      letter-spacing: 0.06em; color: var(--color-navy-2);
      margin: 24px 0 12px; padding-bottom: 8px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }

    /* Donation */
    .donation-section { margin-bottom: 20px; }
    .donation-section legend {
      font-weight: 700; margin: 0 0 8px; font-size: 15px; padding: 0;
    }
    .donation-hint { color: var(--color-muted); font-size: 13px; margin-bottom: 10px; }
    .donation-options { display: flex; gap: 10px; flex-wrap: wrap; }
    .donation-btn {
      padding: 10px 18px; border: 2px solid rgba(0,0,0,0.14); border-radius: 12px;
      background: #fff; font: inherit; font-weight: 700; font-size: 16px;
      color: var(--color-navy-2); cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
    }
    .donation-btn:hover { border-color: var(--color-navy-2); background: rgba(13,44,94,0.04); }
    .donation-btn.active { border-color: var(--color-red); background: rgba(208,0,42,0.06); color: var(--color-red); }
    .donation-btn-none { font-size: 14px; color: var(--color-muted); font-weight: 600; }

    /* Pay button */
    .btn-checkout {
      display: inline-flex; align-items: center; justify-content: center;
      width: 100%; padding: 16px 24px; border-radius: 999px;
      background: var(--color-red); color: #fff;
      font-weight: 800; font-size: 18px; text-decoration: none;
      border: none; cursor: pointer;
      box-shadow: 0 10px 20px rgba(208,0,42,0.25); line-height: 1;
    }
    .btn-checkout:hover { filter: brightness(1.05); }
    .btn-checkout:active { transform: translateY(1px); }
    .btn-checkout:disabled { opacity: 0.6; cursor: not-allowed; filter: none; }

    /* Status states */
    .payment-loading, .payment-success, .payment-error { text-align: center; padding: 40px 20px; }
    .payment-loading { color: var(--color-muted); }
    .payment-success { color: #1a5c32; }
    .payment-success h3 { font-size: 24px; margin: 0 0 10px; }
    .payment-error { color: var(--color-red); }
    .payment-error h3 { font-size: 20px; margin: 0 0 10px; }

    /* Signup step */
    .signup-panel h2 { margin: 0 0 6px; font-size: 22px; }
    .signup-panel > p { margin: 0 0 20px; color: var(--color-muted); font-size: 15px; }
    .signup-paid-badge {
      display: inline-flex; align-items: center; gap: 6px;
      background: rgba(0,166,81,0.08); color: #1a5c32;
      font-weight: 700; font-size: 14px; padding: 6px 14px;
      border-radius: 999px; margin-bottom: 18px;
    }
    .signup-paid-badge svg {
      width: 16px; height: 16px; stroke: #1a5c32; fill: none; stroke-width: 2.5;
    }
    .password-hint { color: var(--color-muted); font-size: 12px; margin-top: 4px; }

    /* Card reveal */
    .card-reveal {
      background: linear-gradient(135deg, var(--color-navy-2), #1a3a6e);
      border-radius: 18px; padding: 28px; color: #fff; text-align: center;
      margin-bottom: 20px;
    }
    .card-reveal-label { font-size: 13px; opacity: 0.7; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 4px; }
    .card-reveal-number { font-size: 28px; font-weight: 800; letter-spacing: 0.04em; margin-bottom: 12px; font-family: 'Courier New', monospace; }
    .card-reveal-name { font-size: 16px; opacity: 0.85; }
    .card-reveal-expiry { font-size: 13px; opacity: 0.6; margin-top: 4px; }

    .spinner {
      width: 36px; height: 36px;
      border: 3px solid rgba(0,0,0,0.1); border-top-color: var(--color-navy-2);
      border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }

    @media (max-width: 980px) {
      .checkout-layout { grid-template-columns: 1fr; padding: 24px 0 40px; }
      .order-summary { position: static; order: -1; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<a class="skip-link" href="#main">Skip to content</a>
<header class="site-header">
  <div class="container header-inner">
    <a class="brand" href="../index.html" aria-label="Camp Card home">
      <picture>
        <source srcset="../assets/scouting-america-cfc-logo.avif" type="image/avif">
        <source srcset="../assets/scouting-america-cfc-logo.webp" type="image/webp">
        <img src="../assets/scouting-america-cfc-logo.png" width="305" height="60" alt="Scouting America — Central Florida Council">
      </picture>
    </a>

    <nav id="site-nav" class="site-nav" aria-label="Primary">
      <a href="../index.html#how-it-works">How it works</a>
      <a href="../index.html#why-camp-card">Why Camp Card</a>
      <a href="../index.html#faq">FAQ</a>
      <a href="../contact/">Contact</a>
    </nav>

    <button class="nav-toggle" type="button" aria-label="Open menu" aria-controls="site-nav" aria-expanded="false">
      <span class="hamburger" aria-hidden="true">
        <span></span><span></span><span></span>
      </span>
    </button>
  </div>
</header>

<main id="main">
  <section class="page-hero">
    <div class="container">
      <h1>Support a Scout</h1>
      <p>A Scout has invited you to get a Camp Card at the special referral price. Your purchase directly funds their camp experience.</p>
    </div>
  </section>

  <div class="container">
    <div class="checkout-layout">
      <!-- Payment Panel -->
      <div class="payment-panel">
        <div class="scout-referral-banner" id="scout-banner">
          <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          <div class="banner-text" id="banner-text">
            You were referred by a Scout &mdash; you get the <strong>special $10 price</strong>!
          </div>
        </div>

        <h2>Payment Details</h2>
        <p>Your card details are securely tokenized and never touch our servers.</p>

        <!-- Checkout Form -->
        <form id="checkout-form" novalidate>
          <div class="form-group">
            <label for="customer-email">Email address</label>
            <input type="email" id="customer-email" placeholder="you@example.com" required autocomplete="email">
            <div class="hint">We'll send your Camp Card confirmation here.</div>
          </div>

          <fieldset class="donation-section" style="border:none;padding:0;margin:20px 0 16px;">
            <legend style="font-weight:700;margin:0 0 8px;font-size:15px;padding:0;">Add an optional donation</legend>
            <div class="donation-hint">100% of your donation goes directly to Scouting programs.</div>
            <div class="donation-options">
              <button type="button" class="donation-btn donation-btn-none active" data-amount="0">No thanks</button>
              <button type="button" class="donation-btn" data-amount="5">+ $5</button>
              <button type="button" class="donation-btn" data-amount="10">+ $10</button>
              <button type="button" class="donation-btn" data-amount="15">+ $15</button>
              <button type="button" class="donation-btn" data-amount="20">+ $20</button>
            </div>
          </fieldset>

          <div class="card-section-label">Card Information</div>

          <div class="form-group">
            <label for="card-number">Card number</label>
            <input type="text" id="card-number" placeholder="1234 5678 9012 3456" required autocomplete="cc-number" inputmode="numeric" maxlength="19">
            <div class="field-error-msg" id="card-number-error">Please enter a valid card number.</div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="card-expiry">Expiration</label>
              <input type="text" id="card-expiry" placeholder="MM / YY" required autocomplete="cc-exp" inputmode="numeric" maxlength="7">
              <div class="field-error-msg" id="card-expiry-error">Enter a valid expiration date.</div>
            </div>
            <div class="form-group">
              <label for="card-cvv">CVV</label>
              <input type="text" id="card-cvv" placeholder="123" required autocomplete="cc-csc" inputmode="numeric" maxlength="4">
              <div class="field-error-msg" id="card-cvv-error">Enter a valid CVV.</div>
            </div>
          </div>

          <div class="form-group">
            <label for="card-name">Name on card</label>
            <input type="text" id="card-name" placeholder="Full name" autocomplete="cc-name">
          </div>

          <div class="form-group">
            <label for="card-zip">Billing ZIP code</label>
            <input type="text" id="card-zip" placeholder="12345" autocomplete="postal-code" inputmode="numeric" maxlength="10">
          </div>

          <!-- Hidden referral code (pre-filled from URL) -->
          <input type="hidden" id="referral-code" value="">

          <div id="form-error" class="hidden" style="color:var(--color-red);font-size:14px;margin-bottom:12px;padding:10px 14px;background:rgba(208,0,42,0.06);border-radius:10px;"></div>

          <button type="submit" class="btn-checkout" id="btn-pay">
            Pay $10.00
          </button>
        </form>

        <!-- Loading -->
        <div id="payment-loading" class="payment-loading hidden">
          <div class="spinner"></div>
          <p>Processing your payment...</p>
        </div>

        <!-- Signup (after payment) -->
        <div id="signup-panel" class="signup-panel hidden">
          <div class="signup-paid-badge">
            <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>
            Payment successful
          </div>
          <h2>Create Your Account</h2>
          <p>Set up your account to access your Camp Card and start saving.</p>

          <form id="signup-form" novalidate>
            <div class="form-row">
              <div class="form-group">
                <label for="signup-first">First name</label>
                <input type="text" id="signup-first" placeholder="First name" required autocomplete="given-name">
                <div class="field-error-msg" id="signup-first-error">First name is required.</div>
              </div>
              <div class="form-group">
                <label for="signup-last">Last name</label>
                <input type="text" id="signup-last" placeholder="Last name" required autocomplete="family-name">
                <div class="field-error-msg" id="signup-last-error">Last name is required.</div>
              </div>
            </div>

            <div class="form-group">
              <label for="signup-email">Email address</label>
              <input type="email" id="signup-email" readonly autocomplete="email" style="background:#f5f5f5;color:var(--color-muted);">
              <div class="hint">Same email used for payment.</div>
            </div>

            <div class="form-group">
              <label for="signup-password">Password</label>
              <input type="password" id="signup-password" placeholder="Create a password" required autocomplete="new-password" minlength="8">
              <div class="password-hint">At least 8 characters.</div>
              <div class="field-error-msg" id="signup-password-error">Password must be at least 8 characters.</div>
            </div>

            <div class="form-group">
              <label for="signup-confirm">Confirm password</label>
              <input type="password" id="signup-confirm" placeholder="Re-enter password" required autocomplete="new-password">
              <div class="field-error-msg" id="signup-confirm-error">Passwords do not match.</div>
            </div>

            <div class="form-group">
              <label for="signup-phone">Phone number <span style="font-weight:400;color:var(--color-muted);">(optional)</span></label>
              <input type="tel" id="signup-phone" placeholder="(555) 123-4567" autocomplete="tel">
            </div>

            <div id="signup-error" class="hidden" style="color:var(--color-red);font-size:14px;margin-bottom:12px;padding:10px 14px;background:rgba(208,0,42,0.06);border-radius:10px;"></div>

            <button type="submit" class="btn-checkout" id="btn-signup">
              Create Account
            </button>
          </form>
        </div>

        <!-- Signup Loading -->
        <div id="signup-loading" class="payment-loading hidden">
          <div class="spinner"></div>
          <p>Creating your account...</p>
        </div>

        <!-- Success (after signup) -->
        <div id="payment-success" class="payment-success hidden">
          <svg style="width:48px;height:48px;stroke:#1a5c32;fill:none;stroke-width:2;margin:0 auto 12px;display:block;" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <path d="M9 12l2 2 4-4"/>
          </svg>
          <h3>You're All Set!</h3>

          <div class="card-reveal" id="card-reveal">
            <div class="card-reveal-label">Your Camp Card</div>
            <div class="card-reveal-number" id="card-number-display"></div>
            <div class="card-reveal-name" id="card-name-display"></div>
            <div class="card-reveal-expiry" id="card-expiry-display"></div>
          </div>

          <p>Download the app and log in to start using your discounts.</p>
          <div style="margin-top:20px;">
            <div class="store-badges" style="justify-content:center;">
              <a class="store-badge" href="#" target="_blank" rel="noopener noreferrer">
                <img src="../assets/app-store-badge.svg" alt="Download on the App Store">
              </a>
              <a class="store-badge" href="#" target="_blank" rel="noopener noreferrer">
                <img src="../assets/google-play-badge.png" alt="Get it on Google Play">
              </a>
            </div>
          </div>
          <p style="margin-top:16px;"><a href="../index.html" style="color:var(--color-navy-2);font-weight:600;">Return to home</a></p>
        </div>

        <!-- Error -->
        <div id="payment-error" class="payment-error hidden">
          <h3>Payment Failed</h3>
          <p id="error-message">We couldn't process your payment. Please try again.</p>
          <button type="button" class="btn-checkout" id="btn-retry" style="max-width:280px;margin:16px auto 0;">Try Again</button>
        </div>
      </div>

      <!-- Order Summary -->
      <div class="order-summary">
        <h2>Order Summary</h2>

        <div class="order-item">
          <div>
            <div class="order-item-name">Scouting America Camp Card</div>
            <div class="order-item-desc">Annual digital discount card</div>
          </div>
          <div class="order-item-price" id="card-price-display">$10.00</div>
        </div>

        <div class="order-item" id="discount-line">
          <div>
            <div class="order-item-name" style="color:#1a5c32;">Scout Referral Discount</div>
            <div class="order-item-desc">Special price from Scout link</div>
          </div>
          <div class="order-item-price" style="color:#1a5c32;">-$5.00</div>
        </div>

        <div class="order-item hidden" id="donation-line">
          <div>
            <div class="order-item-name">Donation</div>
            <div class="order-item-desc">Additional support for Scouts</div>
          </div>
          <div class="order-item-price" id="donation-line-price">$0.00</div>
        </div>

        <div class="order-total">
          <div class="order-total-label">Total</div>
          <div class="order-total-price" id="order-total-price">$10.00</div>
        </div>

        <div class="order-trust">
          <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
          <div>
            <strong>Secure checkout</strong><br>
            Card data is encrypted and tokenized by Authorize.net. It never touches our servers.
          </div>
        </div>

        <div style="margin-top:16px;padding:14px;background:rgba(208,0,42,0.05);border:1px solid rgba(208,0,42,0.15);border-radius:12px;">
          <strong style="font-size:15px;">100% supports Scouting</strong>
          <p style="margin:4px 0 0;font-size:13px;color:var(--color-muted);">Every dollar funds camp experiences, leadership programs, and outdoor adventures for Scouts in Central Florida.</p>
        </div>
      </div>
    </div>
  </div>
</main>

<footer class="site-footer">
  <div class="container footer-inner">
    <div>&copy; 2026 Swipe Savvy, LLC &bull; <a href="../index.html" style="color:inherit;text-decoration:none;">Camp Card</a></div>
    <div class="footer-links">
      <a href="../privacy/">Privacy</a>
      <span aria-hidden="true">&bull;</span>
      <a href="../terms/">Terms</a>
      <span aria-hidden="true">&bull;</span>
      <a href="../contact/">Support</a>
    </div>
  </div>
</footer>

<!-- Accept.js from Authorize.net (sandbox) -->
<script src="https://jstest.authorize.net/v1/Accept.js" charset="utf-8"></script>

<script>
(function() {
  // ── Configuration ──────────────────────────────────────────
  var API_BASE = 'https://api.campcardapp.org/api/v1';
  var AUTHNET_API_LOGIN_ID = '7adF5E2X';
  var AUTHNET_CLIENT_KEY = '9d68fkNfbpS3aS29kkh986FsfSe9SS97s3PuSYeFw7aG7NCMUpG3K24T3XULbJcP';
  var selectedDonation = 0;

  // ── URL params ─────────────────────────────────────────────
  var urlParams = new URLSearchParams(window.location.search);
  var scoutCode = urlParams.get('scout') || '';
  var customerRefCode = urlParams.get('ref') || '';
  var referrerName = urlParams.get('name') || urlParams.get('refname') || '';

  // Scout referral page always uses $10 base price
  var BASE_PRICE = 10;

  // If no scout code provided, redirect to buy-campcard page
  if (!scoutCode && !customerRefCode) {
    window.location.href = '../buy-campcard/' + window.location.search;
    return;
  }

  // ── State ─────────────────────────────────────────────────
  var paymentTransactionId = null;

  // ── DOM refs ───────────────────────────────────────────────
  var form = document.getElementById('checkout-form');
  var loadingEl = document.getElementById('payment-loading');
  var successEl = document.getElementById('payment-success');
  var errorEl = document.getElementById('payment-error');
  var errorMsg = document.getElementById('error-message');
  var formError = document.getElementById('form-error');
  var btnPay = document.getElementById('btn-pay');
  var btnRetry = document.getElementById('btn-retry');

  var signupPanel = document.getElementById('signup-panel');
  var signupForm = document.getElementById('signup-form');
  var signupLoading = document.getElementById('signup-loading');
  var signupError = document.getElementById('signup-error');
  var btnSignup = document.getElementById('btn-signup');

  var emailInput = document.getElementById('customer-email');
  var cardNumber = document.getElementById('card-number');
  var cardExpiry = document.getElementById('card-expiry');
  var cardCvv = document.getElementById('card-cvv');
  var cardName = document.getElementById('card-name');
  var cardZip = document.getElementById('card-zip');
  var referralInput = document.getElementById('referral-code');

  var donationLine = document.getElementById('donation-line');
  var donationLinePrice = document.getElementById('donation-line-price');
  var orderTotalPrice = document.getElementById('order-total-price');
  var donationBtns = document.querySelectorAll('.donation-btn');

  // ── Mobile nav ─────────────────────────────────────────────
  var toggle = document.querySelector('.nav-toggle');
  var nav = document.getElementById('site-nav');
  if (toggle && nav) {
    toggle.addEventListener('click', function() {
      var isOpen = nav.classList.toggle('site-nav--open');
      toggle.setAttribute('aria-expanded', isOpen);
      document.body.classList.toggle('nav-open', isOpen);
    });
  }

  // ── Donation selection ─────────────────────────────────────
  function updateTotal() {
    var total = BASE_PRICE + selectedDonation;
    orderTotalPrice.textContent = '$' + total.toFixed(2);
    btnPay.textContent = 'Pay $' + total.toFixed(2);

    if (selectedDonation > 0) {
      donationLine.classList.remove('hidden');
      donationLinePrice.textContent = '$' + selectedDonation.toFixed(2);
    } else {
      donationLine.classList.add('hidden');
    }
  }

  donationBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      donationBtns.forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      selectedDonation = Number.parseInt(btn.dataset.amount, 10);
      updateTotal();
    });
  });

  // ── Initialize from URL params ───────────────────────────
  (function initFromUrl() {
    // Set referral code
    referralInput.value = scoutCode || customerRefCode;

    // Personalize banner if referrer name is provided
    if (referrerName) {
      var bannerText = document.getElementById('banner-text');
      bannerText.innerHTML = 'Referred by <strong>' + decodeURIComponent(referrerName) + '</strong> &mdash; you get the <strong>special $10 price</strong>!';
    }

    // Update totals
    updateTotal();

    // Track referral link click
    if (scoutCode || customerRefCode) {
      var trackCode = scoutCode || customerRefCode;
      var trackSource = scoutCode ? 'scout_link' : 'referral_link';
      fetch(API_BASE + '/referrals/track', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code: trackCode, source: trackSource })
      }).catch(function() { /* silent fail — tracking is best-effort */ });
    }
  })();

  // ── Card number formatting (spaces every 4 digits) ────────
  cardNumber.addEventListener('input', function() {
    var v = this.value.replace(/\D/g, '').substring(0, 16);
    this.value = v.replace(/(.{4})/g, '$1 ').trim();
  });

  // ── Expiry formatting (MM / YY) ───────────────────────────
  cardExpiry.addEventListener('input', function() {
    var v = this.value.replace(/\D/g, '').substring(0, 4);
    if (v.length >= 3) {
      this.value = v.substring(0, 2) + ' / ' + v.substring(2);
    } else {
      this.value = v;
    }
  });

  // ── CVV: digits only ──────────────────────────────────────
  cardCvv.addEventListener('input', function() {
    this.value = this.value.replace(/\D/g, '').substring(0, 4);
  });

  // ── View management ────────────────────────────────────────
  function showStep(step) {
    form.classList.add('hidden');
    loadingEl.classList.add('hidden');
    successEl.classList.add('hidden');
    errorEl.classList.add('hidden');
    signupPanel.classList.add('hidden');
    signupLoading.classList.add('hidden');

    if (step === 'form') form.classList.remove('hidden');
    if (step === 'loading') loadingEl.classList.remove('hidden');
    if (step === 'success') successEl.classList.remove('hidden');
    if (step === 'error') errorEl.classList.remove('hidden');
    if (step === 'signup') signupPanel.classList.remove('hidden');
    if (step === 'signup-loading') signupLoading.classList.remove('hidden');
  }

  function showFormError(msg) {
    formError.textContent = msg;
    formError.classList.remove('hidden');
  }

  function clearFormError() {
    formError.classList.add('hidden');
  }

  function showFieldError(input, msgEl) {
    input.classList.add('field-error');
    if (msgEl) msgEl.style.display = 'block';
  }

  function clearFieldError(input, msgEl) {
    input.classList.remove('field-error');
    if (msgEl) msgEl.style.display = 'none';
  }

  // ── Validation ─────────────────────────────────────────────
  function validateEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  function validateForm() {
    var valid = true;
    clearFormError();

    if (!validateEmail(emailInput.value.trim())) {
      showFieldError(emailInput);
      valid = false;
    } else {
      clearFieldError(emailInput);
    }

    var rawCard = cardNumber.value.replace(/\s/g, '');
    if (rawCard.length < 13 || rawCard.length > 16) {
      showFieldError(cardNumber, document.getElementById('card-number-error'));
      valid = false;
    } else {
      clearFieldError(cardNumber, document.getElementById('card-number-error'));
    }

    var rawExpiry = cardExpiry.value.replace(/\D/g, '');
    if (rawExpiry.length !== 4) {
      showFieldError(cardExpiry, document.getElementById('card-expiry-error'));
      valid = false;
    } else {
      var month = Number.parseInt(rawExpiry.substring(0, 2), 10);
      if (month < 1 || month > 12) {
        showFieldError(cardExpiry, document.getElementById('card-expiry-error'));
        valid = false;
      } else {
        clearFieldError(cardExpiry, document.getElementById('card-expiry-error'));
      }
    }

    if (cardCvv.value.length < 3 || cardCvv.value.length > 4) {
      showFieldError(cardCvv, document.getElementById('card-cvv-error'));
      valid = false;
    } else {
      clearFieldError(cardCvv, document.getElementById('card-cvv-error'));
    }

    return valid;
  }

  // ── Accept.js tokenization ─────────────────────────────────
  function tokenizeCard(callback) {
    var rawCard = cardNumber.value.replace(/\s/g, '');
    var rawExpiry = cardExpiry.value.replace(/\D/g, '');
    var month = rawExpiry.substring(0, 2);
    var year = '20' + rawExpiry.substring(2, 4);

    var secureData = {
      authData: {
        clientKey: AUTHNET_CLIENT_KEY,
        apiLoginID: AUTHNET_API_LOGIN_ID
      },
      cardData: {
        cardNumber: rawCard,
        month: month,
        year: year,
        cardCode: cardCvv.value
      }
    };

    Accept.dispatchData(secureData, function(response) {
      if (response.messages.resultCode === 'Error') {
        var errors = response.messages.message.map(function(m) { return m.text; });
        callback({ error: errors.join(' ') });
      } else {
        callback({
          dataDescriptor: response.opaqueData.dataDescriptor,
          dataValue: response.opaqueData.dataValue
        });
      }
    });
  }

  // ── Charge via backend ─────────────────────────────────────
  async function chargeBackend(opaqueData) {
    var total = BASE_PRICE + selectedDonation;

    var body = {
      dataDescriptor: opaqueData.dataDescriptor,
      dataValue: opaqueData.dataValue,
      amount: total.toFixed(2),
      customerEmail: emailInput.value.trim(),
      description: 'Camp Card Annual Subscription'
    };

    if (selectedDonation > 0) {
      body.donationAmount = selectedDonation.toFixed(2);
    }

    var referral = referralInput.value.trim();
    if (referral) {
      body.referralCode = referral;
    }

    var res = await fetch(API_BASE + '/payments/subscribe/web-charge', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    return res.json();
  }

  // ── Form submit ────────────────────────────────────────────
  form.addEventListener('submit', function(e) {
    e.preventDefault();

    if (!validateForm()) return;

    showStep('loading');
    btnPay.disabled = true;

    tokenizeCard(function(result) {
      if (result.error) {
        showStep('form');
        showFormError(result.error);
        btnPay.disabled = false;
        return;
      }

      chargeBackend(result).then(function(data) {
        if (data.status === 'SUCCESS') {
          paymentTransactionId = data.transactionId;
          document.getElementById('signup-email').value = emailInput.value.trim();
          showStep('signup');
        } else {
          errorMsg.textContent = data.errorMessage || 'Payment was declined. Please check your card details and try again.';
          showStep('error');
        }
        btnPay.disabled = false;
      }).catch(function() {
        errorMsg.textContent = 'Unable to connect to the payment server. Please check your connection and try again.';
        showStep('error');
        btnPay.disabled = false;
      });
    });
  });

  // ── Retry ──────────────────────────────────────────────────
  btnRetry.addEventListener('click', function() {
    showStep('form');
  });

  // ── Clear field errors on input ────────────────────────────
  [emailInput, cardNumber, cardExpiry, cardCvv].forEach(function(input) {
    input.addEventListener('input', function() {
      clearFieldError(input);
      clearFormError();
    });
  });

  // ── Signup form ──────────────────────────────────────────────
  var signupFirst = document.getElementById('signup-first');
  var signupLast = document.getElementById('signup-last');
  var signupPassword = document.getElementById('signup-password');
  var signupConfirm = document.getElementById('signup-confirm');
  var signupPhone = document.getElementById('signup-phone');

  function validateSignup() {
    var valid = true;
    signupError.classList.add('hidden');

    if (!signupFirst.value.trim()) {
      showFieldError(signupFirst, document.getElementById('signup-first-error'));
      valid = false;
    } else {
      clearFieldError(signupFirst, document.getElementById('signup-first-error'));
    }

    if (!signupLast.value.trim()) {
      showFieldError(signupLast, document.getElementById('signup-last-error'));
      valid = false;
    } else {
      clearFieldError(signupLast, document.getElementById('signup-last-error'));
    }

    if (signupPassword.value.length < 8) {
      showFieldError(signupPassword, document.getElementById('signup-password-error'));
      valid = false;
    } else {
      clearFieldError(signupPassword, document.getElementById('signup-password-error'));
    }

    if (signupConfirm.value !== signupPassword.value) {
      showFieldError(signupConfirm, document.getElementById('signup-confirm-error'));
      valid = false;
    } else {
      clearFieldError(signupConfirm, document.getElementById('signup-confirm-error'));
    }

    return valid;
  }

  signupForm.addEventListener('submit', function(e) {
    e.preventDefault();
    if (!validateSignup()) return;

    showStep('signup-loading');
    btnSignup.disabled = true;

    var body = {
      transactionId: paymentTransactionId,
      firstName: signupFirst.value.trim(),
      lastName: signupLast.value.trim(),
      email: document.getElementById('signup-email').value,
      password: signupPassword.value,
    };

    var phone = signupPhone.value.trim();
    if (phone) body.phone = phone;

    // Pass the correct referral field based on URL param type
    if (scoutCode) {
      body.scoutCode = scoutCode;
    } else if (customerRefCode) {
      body.customerRefCode = customerRefCode;
    }

    fetch(API_BASE + '/payments/subscribe/complete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    })
    .then(function(res) { return res.json(); })
    .then(function(data) {
      if (data.success) {
        document.getElementById('card-number-display').textContent = data.cardNumber || '';
        document.getElementById('card-name-display').textContent = (data.firstName || '') + ' ' + (data.lastName || '');
        if (data.subscriptionExpiresAt) {
          var exp = new Date(data.subscriptionExpiresAt);
          document.getElementById('card-expiry-display').textContent = 'Valid through ' + exp.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        }
        showStep('success');
      } else {
        signupError.textContent = data.errorMessage || 'Could not create your account. Please try again.';
        signupError.classList.remove('hidden');
        showStep('signup');
      }
      btnSignup.disabled = false;
    })
    .catch(function() {
      signupError.textContent = 'Unable to connect. Please check your connection and try again.';
      signupError.classList.remove('hidden');
      showStep('signup');
      btnSignup.disabled = false;
    });
  });

  // Clear signup field errors on input
  [signupFirst, signupLast, signupPassword, signupConfirm].forEach(function(input) {
    input.addEventListener('input', function() {
      clearFieldError(input);
      signupError.classList.add('hidden');
    });
  });
})();
</script>
</body>
</html>
