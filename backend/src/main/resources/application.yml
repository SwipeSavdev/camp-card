# BSA Camp Card Platform - Backend API
# Spring Boot Application Configuration

spring:
  application:
    name: campcard-api
  
  # ============================================================================
  # DATABASE CONFIGURATION
  # ============================================================================
  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:7001}/${DB_NAME:campcard}
    username: ${DB_USERNAME:campcard_user}
    password: ${DB_PASSWORD:changeme}
    driver-class-name: org.postgresql.Driver
    
    # Connection Pool (HikariCP)
    hikari:
      minimum-idle: 10
      maximum-pool-size: 50
      idle-timeout: 300000
      max-lifetime: 600000
      connection-timeout: 20000
      pool-name: CampCardHikariPool
  
  # JPA/Hibernate
  jpa:
    hibernate:
      ddl-auto: validate  # Never auto-create/update in production (use Flyway)
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        "[default_schema]": campcard
        format_sql: true
        jdbc:
          batch_size: 20
        order_inserts: true
        order_updates: true

  # Flyway Database Migrations
  flyway:
    enabled: true
    baseline-on-migrate: true
    locations: classpath:db/migration
    schemas: campcard
    default-schema: campcard
    table: flyway_schema_history
  
  # ============================================================================
  # REDIS CACHE CONFIGURATION
  # ============================================================================
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: 0
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 50
          max-idle: 20
          min-idle: 5
          max-wait: 1000ms
  
  cache:
    type: redis
    redis:
      time-to-live: 300000  # 5 minutes default TTL
      cache-null-values: false
  
  # ============================================================================
  # KAFKA CONFIGURATION
  # ============================================================================
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:7004}
    
    # Producer
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      acks: all
      retries: 3
      properties:
        max.in.flight.requests.per.connection: 5
        enable.idempotence: true
    
    # Consumer
    consumer:
      group-id: campcard-api-consumer
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      auto-offset-reset: earliest
      enable-auto-commit: false
      properties:
        spring.json.trusted.packages: "org.bsa.campcard.*"
    
    # Topics
    topics:
      subscription-events: subscription-events
      referral-events: referral-events
      redemption-events: redemption-events
      notification-events: notification-events
      audit-events: audit-events
      payment-events: payment-events

# ============================================================================
# SECURITY CONFIGURATION
# ============================================================================
security:
  jwt:
    secret: ${JWT_SECRET:changeme-use-secrets-manager-in-production}
    expiration: 900000  # 15 minutes (access token)
    refresh-expiration: 604800000  # 7 days (refresh token)
    issuer: campcard-api
  
  cors:
    allowed-origins:
      - https://app.campcard.org
      - https://admin.campcard.org
      - http://localhost:3000  # Dev only
    allowed-methods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
    allowed-headers:
      - Authorization
      - Content-Type
      - X-Idempotency-Key
      - X-Council-ID
    max-age: 3600

# ============================================================================
# STRIPE PAYMENT CONFIGURATION
# ============================================================================
stripe:
  api-key: ${STRIPE_API_KEY:sk_test_changeme}
  webhook-secret: ${STRIPE_WEBHOOK_SECRET:whsec_changeme}
  success-url: https://app.campcard.org/subscription/success
  cancel-url: https://app.campcard.org/subscription/cancel

# ============================================================================
# AUTHORIZE.NET PAYMENT CONFIGURATION
# ============================================================================
authorize:
  net:
    api:
      login:
        id: ${AUTHORIZE_NET_API_LOGIN_ID:}
    transaction:
      key: ${AUTHORIZE_NET_TRANSACTION_KEY:}
    environment: ${AUTHORIZE_NET_ENVIRONMENT:SANDBOX}

# ============================================================================
# AWS CONFIGURATION
# ============================================================================
aws:
  region: ${AWS_REGION:us-east-2}
  s3:
    bucket: ${S3_BUCKET:campcard-assets-prod}
  ses:
    # Verified email identity in AWS SES
    from-email: ${SES_FROM_EMAIL:no-reply@campcard.org}
  sns:
    # SMS sender ID (alphanumeric, max 11 chars)
    sender-id: ${SNS_SENDER_ID:CampCard}
  secrets-manager:
    enabled: true
    secret-name: campcard/api/secrets
  cloudwatch:
    namespace: CampCard/API
    enabled: true
  # AWS Location Service Configuration
  location:
    enabled: ${LOCATION_ENABLED:true}
    place-index: ${LOCATION_PLACE_INDEX:campcard-place-index}
    route-calculator: ${LOCATION_ROUTE_CALCULATOR:campcard-route-calculator}
    geofence-collection: ${LOCATION_GEOFENCE_COLLECTION:campcard-geofences}
    tracker: ${LOCATION_TRACKER:campcard-tracker}
    map: ${LOCATION_MAP:campcard-map}

# ============================================================================
# TOGETHER.AI CONFIGURATION
# ============================================================================
together:
  ai:
    api-key: ${TOGETHER_AI_API_KEY:}
    base-url: https://api.together.xyz/v1
    default-model: meta-llama/Llama-3.3-70B-Instruct-Turbo

# ============================================================================
# APPLICATION CONFIGURATION
# ============================================================================
campcard:
  # Multi-Tenant Settings
  tenant:
    default-council-id: 1  # Used for system operations
  
  # Referral Settings
  referral:
    max-depth: 5  # Max customer-to-customer referral chain depth
    click-rate-limit: 10  # Max clicks per hour per IP per Scout
    code-length: 8  # Character length for referral codes
  
  # POS Claim Link Settings
  pos:
    claim-link-expiry-days: 7
    claim-token-length: 12
  
  # Redemption Settings
  redemption:
    code-expiry-minutes: 10
    code-length: 6
  
  # Rate Limiting
  rate-limit:
    enabled: true
    redis-key-prefix: "rate_limit:"
    default-limit: 100  # Requests per minute
    burst-capacity: 20
  
  # Base URL for the application (production: https://api.campcardapp.org)
  base-url: ${CAMPCARD_BASE_URL:https://api.campcardapp.org}

  # Web Portal URL for password reset and email verification links
  # Production: https://campcardapp.org
  # Development: http://localhost:3000 or http://YOUR_EC2_IP:7020
  web-portal-url: ${CAMPCARD_WEB_PORTAL_URL:https://campcardapp.org}

  # Notifications (AWS SES for email, AWS SNS for SMS)
  notifications:
    email:
      from: ${SES_FROM_EMAIL:no-reply@campcardapp.org}
      enabled: ${EMAIL_ENABLED:true}  # SES is configured for campcardapp.org
    sms:
      enabled: ${SMS_ENABLED:false}  # Set to true when SNS is configured
      sender-id: ${SNS_SENDER_ID:CampCard}
  
  # Dashboard Caching
  dashboard:
    cache-ttl:
      scout: 60  # 60 seconds
      troop: 60
      council: 300  # 5 minutes
      national: 600  # 10 minutes

# ============================================================================
# LOGGING CONFIGURATION
# ============================================================================
logging:
  level:
    root: INFO
    org.bsa.campcard: DEBUG
    org.springframework.web: INFO
    org.springframework.security: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
  
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  
  file:
    name: ${LOG_FILE:/var/log/campcard/api.log}
    max-size: 100MB
    max-history: 30
    total-size-cap: 3GB

# ============================================================================
# ACTUATOR ENDPOINTS (Monitoring & Health Checks)
# ============================================================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
  
  health:
    db:
      enabled: true
    redis:
      enabled: true
    diskspace:
      enabled: true
  
  metrics:
    export:
      cloudwatch:
        namespace: CampCard/API
        enabled: true
        step: 1m

# ============================================================================
# SERVER CONFIGURATION
# ============================================================================
server:
  port: ${SERVER_PORT:7010}
  
  # HTTP/2 Support
  http2:
    enabled: true
  
  # Compression
  compression:
    enabled: true
    mime-types:
      - application/json
      - application/xml
      - text/html
      - text/xml
      - text/plain
  
  # Error Handling
  error:
    include-message: always
    include-binding-errors: always
    include-stacktrace: never  # Never expose stack traces in production
    include-exception: false
  
  # Tomcat Settings
  tomcat:
    max-threads: 200
    min-spare-threads: 10
    accept-count: 100
    max-connections: 10000
    connection-timeout: 20000
    
  # SSL/TLS (Handled by ALB in production, local dev only)
  ssl:
    enabled: ${SSL_ENABLED:false}

---
# ============================================================================
# DEVELOPMENT PROFILE
# ============================================================================
spring:
  config:
    activate:
      on-profile: dev

  datasource:
    url: jdbc:postgresql://localhost:7001/campcard_dev
    username: postgres
    password: postgres
    driver-class-name: org.postgresql.Driver

  jpa:
    show-sql: true
    hibernate:
      ddl-auto: validate  # Schema managed by Flyway

  redis:
    host: localhost
    port: 7002
    password: devpassword

  kafka:
    bootstrap-servers: localhost:7004

logging:
  level:
    org.bsa.campcard: DEBUG
    org.springframework.security: DEBUG

security:
  cors:
    allowed-origins: "*"

campcard:
  rate-limit:
    enabled: false

---
# ============================================================================
# STAGING PROFILE
# ============================================================================
spring:
  config:
    activate:
      on-profile: staging

  datasource:
    url: jdbc:postgresql://${DB_HOST}:5432/campcard_staging
  
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS}

aws:
  region: us-east-1
  s3:
    bucket: campcard-assets-staging

campcard:
  notifications:
    email:
      from: staging@campcard.org

logging:
  level:
    root: INFO
    org.bsa.campcard: DEBUG

---
# ============================================================================
# PRODUCTION PROFILE
# ============================================================================
spring:
  config:
    activate:
      on-profile: prod

  datasource:
    url: jdbc:postgresql://${DB_HOST}:5432/campcard_prod
    hikari:
      maximum-pool-size: 100
  
  jpa:
    show-sql: false
  
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS}

aws:
  region: us-east-1
  s3:
    bucket: campcard-assets-prod
  secrets-manager:
    enabled: true

security:
  cors:
    allowed-origins:
      - https://app.campcard.org
      - https://admin.campcard.org

logging:
  level:
    root: WARN
    org.bsa.campcard: INFO
    org.springframework.security: WARN
    org.hibernate.SQL: WARN

campcard:
  rate-limit:
    enabled: true
    default-limit: 100

# Together.AI Configuration
together:
  ai:
    api-key: ${TOGETHER_AI_API_KEY:}
    base-url: https://api.together.xyz/v1
    default-model: meta-llama/Llama-3.3-70B-Instruct-Turbo
